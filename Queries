-- 1. Write a SQL query to retrieve all patients who have been diagnosed with COVID-19

SELECT PATIENT_NAME, DIAGNOSIS_NAME FROM VISITS JOIN DIAGNOSES 
USING (DIAGNOSIS_ID) 
JOIN PATIENTS
USING(PATIENT_ID)
WHERE DIAGNOSIS_NAME = "COVID-19"
ORDER BY PATIENT_ID;

-- 2. Write a SQL query to retrieve the number of visits made by each patient, ordered by the number of visits in descending order.

SELECT PATIENT_ID,PATIENT_NAME, COUNT(PATIENT_ID) AS TOTAL_VISITS
FROM VISITS 
JOIN PATIENTS
USING(PATIENT_ID)
GROUP BY PATIENT_ID
ORDER BY TOTAL_VISITS DESC;

-- 3. Write a SQL query to calculate the average age of patients who have been diagnosed with Pneumonia.

SELECT DIAGNOSIS_NAME, AVG(AGE) FROM VISITS
JOIN PATIENTS USING(PATIENT_ID) 
JOIN DIAGNOSES USING(DIAGNOSIS_ID)
WHERE DIAGNOSIS_NAME = "PNEUMONIA" ORDER BY DIAGNOSIS_ID;

-- 4. Write a SQL query to retrieve the top 3 most common symptoms among all visits.

WITH TEMP AS(
SELECT SYMPTOM_ID, COUNT(SYMPTOM_ID) AS MORE_FREQUENT_SYMPTOM,
RANK() OVER(ORDER BY COUNT(SYMPTOM_ID) DESC) AS RN
FROM VISITS GROUP BY SYMPTOM_ID)

SELECT SYMPTOM_NAME FROM TEMP JOIN SYMPTOMS USING(SYMPTOM_ID) WHERE RN <= 3 ORDER BY MORE_FREQUENT_SYMPTOM DESC;

-- 5. Write a SQL query to retrieve the patient who has the highest number of different symptoms reported.

WITH TEMP AS (
SELECT PATIENT_ID, COUNT(SYMPTOM_ID) AS TOTAL_DIFF_SYMPTOMS,
DENSE_RANK() OVER(ORDER BY COUNT(SYMPTOM_ID) DESC) AS RN
FROM VISITS GROUP BY PATIENT_ID)

SELECT PATIENT_NAME, TOTAL_DIFF_SYMPTOMS FROM TEMP JOIN PATIENTS USING (PATIENT_ID)
WHERE RN = 1;

-- 6. Write a SQL query to calculate the percentage of patients who have been diagnosed with COVID-19 out of the total number of patients.

WITH TEMP AS (
SELECT COUNT(DISTINCT PATIENT_ID) AS COVID19_PATIENTS, 
-- HERE FROM VISITS IF A PAITENT VISIT ONE OR MULTIPLE TIMES ON SAME DIAGNOSIS FOR THAT WE TOOK DISTINCT PATIENTS TO GET NO.OF PATIENTS ON THAT DIAGNOSIS
(SELECT COUNT(*) FROM VISITS)  AS TOTAL_PATIENTS 
-- HERE CALCULATING TOTAL VISITS, BCZ IN ALL VISITS PATIENTS MAY VISIT MULTIPLE OR SINGLE TIMES FOR SAME DIAGNOSIS, WE GET TOTAL PATIENTS FOR ALL DAYS.
FROM VISITS
JOIN DIAGNOSES
USING(DIAGNOSIS_ID)
WHERE DIAGNOSIS_NAME = "COVID-19")

SELECT CONCAT(ROUND((COVID19_PATIENTS/TOTAL_PATIENTS)*100,0),"%") AS "% COVID-19 PATIENTS" FROM TEMP;

-- -------------2ND METHOD--------------------
SELECT (COUNT(CASE WHEN DIAGNOSIS_NAME = 'COVID-19' THEN 1 END)/COUNT(*) *100) AS PERCENTAGE
FROM PATIENTS P
JOIN DIAGNOSES D ON P.PATIENT_ID = D.DIAGNOSIS_ID;

-- 7. Write a SQL query to retrieve the top 5 cities with the highest number of visits, along with the count of visits in each city.

WITH TEMP AS (
SELECT CITY, COUNT(*) AS NO_OF_VISITS, RANK() OVER(ORDER BY COUNT(*) DESC) AS RN
FROM VISITS
JOIN PATIENTS
USING(PATIENT_ID)
GROUP BY CITY)

SELECT * FROM TEMP WHERE RN<=5;

-- 8. Write a SQL query to find the patient who has the highest number of visits in a single day, along with the corresponding visit date.

SELECT PATIENT_NAME, VISIT_DATE, NO_OF_VISITS FROM(
SELECT PATIENT_NAME, VISIT_DATE, COUNT(*) AS NO_OF_VISITS, RANK() OVER(ORDER BY COUNT(*) DESC) AS RN
FROM PATIENTS
JOIN VISITS
USING(PATIENT_ID)
GROUP BY PATIENT_ID, VISIT_DATE) AS SUB WHERE RN = 1;

-- 9. Write a SQL query to retrieve the average age of patients for each diagnosis, ordered by the average age in descending order.

WITH TEMP AS(
SELECT DISTINCT DIAGNOSIS_ID, PATIENT_ID, AGE FROM VISITS
JOIN PATIENTS USING(PATIENT_ID) ORDER BY DIAGNOSIS_ID)

SELECT DIAGNOSIS_NAME, ROUND(AVG(AGE),2) AS AVG_PATIENT_AGE FROM TEMP 
JOIN DIAGNOSES USING(DIAGNOSIS_ID) GROUP BY DIAGNOSIS_ID ORDER BY 2 DESC;

-- 10. Write a SQL query to calculate the cumulative count of visits over time, ordered by the visit date.

SELECT VISIT_DATE, SUM(count(*)) OVER(ORDER BY VISIT_DATE) CUMULATIVE_VISITS FROM VISITS GROUP BY VISIT_DATE;

